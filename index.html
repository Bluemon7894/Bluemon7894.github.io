<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>í—¬í• ì¬í™œ ìì„¸ ë°ëª¨</title>
<meta name="color-scheme" content="dark">
<link rel="icon" type="image/png" href="helfit%20logo.png">
<style>
  :root{--bg:#070a12;--panel:#0e1421f2;--muted:#9fb0c3;--line:#25324b;--brand:#8ec5ff;--ok:#28d790;--warn:#ffcc66;--bad:#ff7a9e;--chip:#14233a;--card:#0b1220d9;--shadow:0 10px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);--round:18px}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Pretendard,sans-serif;color:#eaf2ff;background:
    radial-gradient(1200px 600px at 10% -10%, #0f2a5a44, transparent),
    radial-gradient(1100px 600px at 90% 0%, #3b138a33, transparent),
    linear-gradient(180deg,#0a0f1e 0%,#070a12 60%,#070a12 100%)}
  header{position:sticky;top:0;z-index:30;border-bottom:1px solid #18243a;backdrop-filter:blur(10px);background:linear-gradient(90deg,#0a1224cc,#0b0f1ecc 60%,#0a1224cc)}
  .nav{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
  #logo{height:28px;width:auto;display:block;filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
  .chip{margin-left:8px;padding:6px 10px;border-radius:999px;background:#14233a;border:1px solid #244065;color:#8ec5ff;font-weight:700}
  .status{margin-left:auto;padding:8px 12px;border-radius:12px;border:1px solid #1f2e4b;background:#0f1627;color:#cfe2ff;font-weight:800}
  .status.ok{background:#0d1f1a;border-color:#266a4e;color:var(--ok)}
  .status.warn{background:#20180d;border-color:#7a5a1f;color:var(--warn)}
  .status.bad{background:#211018;border-color:#6e223f;color:var(--bad)}
  .wrap{max-width:1200px;margin:22px auto;padding:0 18px}
  .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:18px}
  @media (max-width:1024px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--round);box-shadow:var(--shadow)}
  .card-body{padding:16px}
  #canvas{width:100%;height:auto;border-radius:14px;background:#000;display:block}
  #video{display:none}
  .stage-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .stage-title{font-weight:800}
  .pill{padding:6px 10px;border-radius:999px;background:#0f1a2a;border:1px solid #2a3b58;color:#cfe2ff;font-weight:700}
  .stack{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row-spread{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  select,.btn,.btn-ghost{padding:10px 12px;border-radius:12px;border:1px solid #2a3b58;background:#0e1626;color:#e7f1ff;font-weight:800}
  .btn{background:linear-gradient(180deg,#1a3a6b,#122240);border-color:#2b4777}
  .btn:hover{filter:brightness(1.08)}
  .btn.ok{background:linear-gradient(180deg,#1c4d3a,#113424);border-color:#2b7a58}
  .btn.bad{background:linear-gradient(180deg,#5a2133,#2a1120);border-color:#80304b}
  .btn-ghost{background:#0c1322}
  .count{padding:4px 10px;border-radius:999px;background:#0f1a2a;border:1px solid #2b4777;color:#9ecbff;font-weight:900}
  label{font-size:12px;color:#9fb0c3}
  .muted{color:#9fb0c3;font-size:13px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:#b9c7da}
  .footer{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:900px){.footer{grid-template-columns:1fr}}
  .tip,.credit{background:#0e1421f2;border:1px solid #25324b;border-radius:var(--round);padding:14px;box-shadow:var(--shadow)}
  .tip h4{margin:0 0 8px}
  .tag{padding:4px 10px;border-radius:999px;background:#111b2a;border:1px solid #294164;color:#9ecbff;font-weight:800}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;background:#0f1627;border:1px solid #2a3b58;border-radius:12px;padding:10px 14px;color:#cfe2ff;box-shadow:var(--shadow);transition:all .28s ease;z-index:40;font-weight:800}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  #starter{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#070a12ee;z-index:99}
  #starter .panel{background:#0e1421f2;border:1px solid #25324b;border-radius:16px;padding:18px;box-shadow:var(--shadow);text-align:center}
  .spin{width:16px;height:16px;border-radius:50%;border:3px solid #2a3b58;border-top-color:#9ec5ff;display:inline-block;animation:rot .8s linear infinite;margin-right:6px}
  @keyframes rot{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="./" aria-label="í—¬í• í™ˆ">
        <img id="logo" src="helfit%20logo.png" alt="í—¬í• ë¡œê³ ">
      </a>
      <div class="chip">MoveNet (TF.js)</div>
      <div id="status" class="status"><span class="spin"></span>ì´ˆê¸°í™” ì¤‘â€¦</div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="card-body">
          <div class="stage-head">
            <div class="stage-title">ì¹´ë©”ë¼</div>
            <div class="pill" id="secureInfo">HTTPS: í™•ì¸ ì¤‘â€¦</div>
          </div>
          <canvas id="canvas" width="960" height="540"></canvas>
          <video id="video" playsinline webkit-playsinline muted autoplay></video>
        </div>
      </section>

      <aside class="card">
        <div class="card-body stack">
          <div class="row-spread">
            <div>
              <label for="exercise">ìš´ë™ ì„ íƒ</label><br/>
              <select id="exercise">
                <option value="lunge">ëŸ°ì§€</option>
                <option value="knee_ext">ë¬´ë¦ ì‹ ì „</option>
                <option value="sit_to_stand">ì•‰ì•˜ë‹¤ ì¼ì–´ë‚˜ê¸°</option>
              </select>
            </div>
            <div class="row" style="gap:6px">
              <div class="count" title="ì¢‹ì€ ìƒ˜í”Œ">G: <span id="cnt-good">0</span></div>
              <div class="count" title="ë‚˜ìœ ìƒ˜í”Œ">B: <span id="cnt-bad">0</span></div>
              <div class="count" title="ê³µìœ (ì›ê²©) ìƒ˜í”Œ">Cloud: <span id="cnt-cloud">0</span></div>
            </div>
          </div>

          <div class="row">
            <button class="btn ok" id="btn-good" title="ë‹¨ì¶•í‚¤ G">ì¢‹ì€ ìƒ˜í”Œ ì €ì¥ (G)</button>
            <button class="btn bad" id="btn-bad" title="ë‹¨ì¶•í‚¤ B">ë‚˜ìœ ìƒ˜í”Œ ì €ì¥ (B)</button>
            <button class="btn-ghost" id="btn-reset-cloud" title="ê³µìœ  ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”">ê³µìœ  ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”</button>
            <button class="btn-ghost" id="flipCam" style="display:none">ì „/í›„ë©´ ì „í™˜</button>
          </div>

          <div class="tip">
            <h4>ì„¤ëª…</h4>
            <div class="muted">ì¹´ë©”ë¼ â†’ <b>MoveNet</b> â†’ ë™ì‘ë³„ <b>ê´€ì ˆê° íŠ¹ì§•</b> â†’ <b>ê¸°ë³¸ + ë¡œì»¬ + ê³µìœ (Firebase)</b> ìœ ì‚¬ë„ â†’ í”¼ë“œë°±.<br/>G/B ì €ì¥ ì‹œ ë¡œì»¬+í´ë¼ìš°ë“œì— ë™ì‹œ ì €ì¥ë©ë‹ˆë‹¤. (ê±°ìš¸ ëª¨ë“œ ON)</div>
          </div>

          <div class="mono" id="debug"></div>
        </div>
      </aside>
    </div>

    <div class="footer">
      <div class="tip">
        <h4>ë°ëª¨ íŒ</h4>
        <ul class="muted" style="margin:6px 0 0 18px">
          <li><b>í•œ ëª…ë§Œ</b> í™”ë©´ì— ë‚˜ì˜¤ê²Œ í•´ì£¼ì„¸ìš”.</li>
          <li><b>ì „ì‹ </b>ì´ ë³´ì´ë„ë¡ 1.5~2m ê±°ë¦¬ì—ì„œ ì´¬ì˜í•˜ë©´ ì •í™•ë„ê°€ ì¢‹ì•„ìš”.</li>
        </ul>
      </div>
      <div class="credit">
        <div class="row-spread">
          <div class="muted">í˜„ì¬ ìš´ë™: <span class="tag" id="ex-tag">ëŸ°ì§€</span></div>
          <div class="muted">ìƒ˜í”Œ: <span class="tag">ê¸°ë³¸ + ë¡œì»¬ + ê³µìœ (Firebase)</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="starter">
    <div class="panel">
      <h3 style="margin:0 0 8px">í—¬í• ì¬í™œ ìì„¸ ë°ëª¨</h3>
      <p class="muted" style="margin:0 0 14px">ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•˜ê³  ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì‹œì‘í•©ë‹ˆë‹¤.</p>
      <button id="btnStart" class="btn">ì¹´ë©”ë¼ ì‹œì‘</button>
      <div class="muted" style="margin-top:8px;font-size:12px">ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ë‹¤ë¥¸ ë¸Œë¼ìš°ì €(í¬ë¡¬/ì‚¬íŒŒë¦¬)ë¡œ ì‹œë„</div>
    </div>
  </div>

  <div id="toast" class="toast">ë©”ì‹œì§€</div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script>
  /* ===== ì„¤ì • ===== */
  const MIRROR = true; // ê±°ìš¸ ëª¨ë“œ ON

  /* ===== ê³µí†µ ===== */
  const $ = s=>document.querySelector(s);
  const statusEl = $('#status'), toast=$('#toast');
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const video=$('#video'), canvas=$('#canvas'), ctx=canvas.getContext('2d');
  const container = canvas.parentElement;

  function setStatus(t,tone=''){ statusEl.className='status '+tone; statusEl.innerHTML=(tone?'':'<span class="spin"></span>')+t; }
  function showToast(t,ms=1800){ toast.textContent=t; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),ms); }
  if(isMobile) $('#starter').style.display='flex'; else $('#starter').style.display='none';
  if(isMobile) $('#flipCam').style.display='inline-block';

  /* ===== ê°„ì´ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸(ì„¸ì…˜ ë‹¨ìœ„) ===== */
  const ADMIN_PASSWORD = 'Bluemon7894';
  let isAuthed = false;
  async function ensureAuth(reason='ë³´í˜¸ëœ ì‘ì—…'){
    if(isAuthed) return true;
    const pw = prompt(`ğŸ”’ ${reason}ì„(ë¥¼) ìˆ˜í–‰í•˜ë ¤ë©´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
    if(pw === ADMIN_PASSWORD){ isAuthed = true; showToast('ì¸ì¦ ì„±ê³µ'); return true; }
    showToast('ì¸ì¦ ì‹¤íŒ¨'); return false;
  }

  /* ===== Firebase ===== */
  const FIREBASE_BASE = 'https://helfit-rehab-default-rtdb.asia-southeast1.firebasedatabase.app';

  async function fbGet(path) {
    const url = `${FIREBASE_BASE}${path}.json`;
    const res = await fetch(url, { method:'GET', mode:'cors' });
    const text = await res.text();
    if(!res.ok){ console.error('Firebase GET ì‹¤íŒ¨:', res.status, text); throw new Error(`Firebase GET ì‹¤íŒ¨ ${res.status}`); }
    try { return JSON.parse(text); } catch { return null; }
  }
  async function fbPost(path, data) {
    const url = `${FIREBASE_BASE}${path}.json`;
    const res = await fetch(url, {
      method:'POST',
      mode:'cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const text = await res.text();
    if(!res.ok){ console.error('Firebase POST ì‹¤íŒ¨:', res.status, text); throw new Error(`Firebase POST ì‹¤íŒ¨ ${res.status}`); }
    try { return JSON.parse(text); } catch { return null; }
  }
  async function fbDelete(path) {
    const url = `${FIREBASE_BASE}${path}.json`;
    const res = await fetch(url, { method:'DELETE', mode:'cors' });
    const text = await res.text();
    if(!res.ok){ console.error('Firebase DELETE ì‹¤íŒ¨:', res.status, text); throw new Error(`Firebase DELETE ì‹¤íŒ¨ ${res.status}`); }
    return true;
  }

  /* ===== ê¸°ë³¸ ìƒ˜í”Œ(ì„¸ ë™ì‘) ===== */
  const DEFP={
    lunge:{good:{LK:[95,15],RK:[95,15],LH:[80,15],RH:[80,15],T:[25,10]},
           bad :{LK:[40,15],RK:[140,15],LH:[30,15],RH:[120,15],T:[5,8]}},
    knee_ext:{good:{LK:[175,6],RK:[175,6],LH:[170,8],RH:[170,8],T:[8,6]},
              bad :{LK:[120,20],RK:[120,20],LH:[130,20],RH:[130,20],T:[25,12]}},
    sit_to_stand:{good:{LK:[175,8],RK:[175,8],LH:[170,10],RH:[170,10],T:[10,8]},
                  bad :{LK:[90,20],RK:[90,20],LH:[120,20],RH:[120,20],T:[28,12]}}
  };
  const clamp=v=>Math.max(0,Math.min(180,v));
  function expand(spec,k=3){
    const R=([c,d])=>k===1?[c]:(k===2?[c-d,c+d]:[c-d,c,c+d]);
    const A=R(spec.LK),B=R(spec.RK),C=R(spec.LH),D=R(spec.RH),E=R(spec.T),out=[];
    for(const a of A)for(const b of B)for(const c of C)for(const d of D)for(const e of E) out.push([clamp(a),clamp(b),clamp(c),clamp(d),clamp(e)]);
    return dedup(out,3.0)
  }
  function dedup(list,thr){const o=[];list.forEach(v=>{const same=o.some(u=>v.reduce((s,x,i)=>s+Math.abs(x-u[i]),0)/v.length<thr);if(!same)o.push(v)});return o}
  const DEFAULT_SAMPLES=['lunge','knee_ext','sit_to_stand']
    .reduce((a,e)=>(a[e]={good:expand(DEFP[e].good,3),bad:expand(DEFP[e].bad,2)},a),{});

  /* ===== ìƒíƒœ/íŒŒë¼ë¯¸í„° ===== */
  const cntG=$('#cnt-good'),cntB=$('#cnt-bad'),cntC=$('#cnt-cloud');
  const exSel=$('#exercise'),exTag=$('#ex-tag'),debugEl=$('#debug');
  const KP={NOSE:0,L_EYE:1,R_EYE:2,L_EAR:3,R_EAR:4,L_SHO:5,R_SHO:6,L_ELB:7,R_ELB:8,L_WR:9,R_WR:10,L_HIP:11,R_HIP:12,L_KNEE:13,R_KNEE:14,L_ANK:15,R_ANK:16};
  const CONF_THR=.2,MAX_SAMPLES=250,THR_GOOD=8,MARGIN=2,MAX_POSES=isMobile?1:4;
  let detector,EX=localStorage.getItem('last_ex')||'lunge'; exSel.value=EX; if($('#ex-tag')) $('#ex-tag').textContent=exSel.options[exSel.selectedIndex].text;

  const key=e=>`rehab_${e}_samples_v1`;
  function loadRaw(e){try{const o=JSON.parse(localStorage.getItem(key(e))||'{}');return{good:o.good||[],bad:o.bad||[]}}catch{return{good:[],bad:[]}}}
  const save=(e,o)=>localStorage.setItem(key(e),JSON.stringify(o));
  const addLocal=(e,t,f)=>{const s=loadRaw(e);s[t]=[...s[t],f].slice(-MAX_SAMPLES);save(e,s);updateCounts()}

  // ê³µìœ  ìºì‹œ
  const cloudCache = {};
  async function loadCloudOnce(ex){
    if(cloudCache[ex]) return cloudCache[ex];
    try{
      const data = await fbGet(`/rehab_samples/${ex}`);
      const good=[], bad=[];
      if(data && typeof data==='object'){
        if(data.good && typeof data.good==='object'){
          Object.values(data.good).forEach(v=>{ if(Array.isArray(v)&&v.length===5) good.push(v) });
        }
        if(data.bad && typeof data.bad==='object'){
          Object.values(data.bad).forEach(v=>{ if(Array.isArray(v)&&v.length===5) bad.push(v) });
        }
      }
      cloudCache[ex] = {good,bad};
      updateCounts();
      return cloudCache[ex];
    }catch(e){
      console.warn('í´ë¼ìš°ë“œ ë¡œë“œ ì‹¤íŒ¨:', e);
      cloudCache[ex] = {good:[],bad:[]};
      updateCounts();
      return cloudCache[ex];
    }
  }
  async function addCloud(ex, type, f){
    try{
      await fbPost(`/rehab_samples/${ex}/${type}`, f);
      if(!cloudCache[ex]) cloudCache[ex]={good:[],bad:[]};
      cloudCache[ex][type].push(f);
      updateCounts();
    }catch(e){
      console.warn('ê³µìœ  ì €ì¥ ì‹¤íŒ¨:', e);
      showToast('ê³µìœ  ì €ì¥ ì‹¤íŒ¨(ë„¤íŠ¸ì›Œí¬/ê·œì¹™/í¬ê¸° í™•ì¸)');
    }
  }
  function loadAllMerged(e){
    const base = DEFAULT_SAMPLES[e]||{good:[],bad:[]};
    const loc  = loadRaw(e);
    const cloud= cloudCache[e] || {good:[],bad:[]};
    return { good:[...base.good, ...cloud.good, ...loc.good],
             bad :[...base.bad,  ...cloud.bad,  ...loc.bad ] };
  }
  function updateCounts(){
    const s = loadAllMerged(EX);
    cntG.textContent = s.good.length;
    cntB.textContent = s.bad.length;
    const cloud = cloudCache[EX] || {good:[],bad:[]};
    cntC.textContent = (cloud.good.length + cloud.bad.length);
  }

  /* ===== ê°ë„/ê¸°í•˜ ===== */
  const sel=(k,i)=>{const p=k[i],s=p?.score??p?.confidence??0;return s<CONF_THR?null:{x:p.x,y:p.y,score:s}}
  const deg=(a,b,c)=>{if(!a||!b||!c)return null;const v1=[a.x-b.x,a.y-b.y],v2=[c.x-b.x,c.y-b.y],n1=Math.hypot(...v1),n2=Math.hypot(...v2);if(!n1||!n2)return null;let cos=(v1[0]*v2[0]+v1[1]*v2[1])/(n1*n2);cos=Math.max(-1,Math.min(1,cos));return Math.acos(cos)*180/Math.PI}
  const torso=(s,h)=>{if(!s||!h)return null;const vx=h.x-s.x,vy=h.y-s.y,n=Math.hypot(vx,vy);if(!n)return null;let cos=vy/n;cos=Math.max(-1,Math.min(1,cos));return Math.acos(cos)*180/Math.PI}
  const MAE=(a,b)=>a.reduce((s,v,i)=>s+Math.abs(v-b[i]),0)/a.length

  /* ===== ë¹„ë””ì˜¤/ì¢Œí‘œ(ê±°ìš¸ ëª¨ë“œ í¬í•¨) ===== */
  let cover = {sx:0,sy:0,sw:1,sh:1,dw:1,dh:1,scale:1};
  function computeCover(dw,dh,vw,vh){
    const s = Math.max(dw/vw, dh/vh);
    const sw = dw/s, sh = dh/s;
    const sx = (vw - sw)/2, sy = (vh - sh)/2;
    cover = {sx,sy,sw,sh,dw,dh,scale:(dw/sw)};
    return cover;
  }
  function drawVideoCover(){
    const {sx,sy,sw,sh,dw,dh} = cover;
    if(MIRROR){
      ctx.save();
      ctx.translate(canvas.width,0);
      ctx.scale(-1,1);
      ctx.drawImage(video, sx,sy,sw,sh, 0,0,dw,dh);
      ctx.restore();
    }else{
      ctx.drawImage(video, sx,sy,sw,sh, 0,0,dw,dh);
    }
  }
  function mapKeypoints(pose){
    const k = pose.keypoints;
    const mapped = k.map(p=>{
      let x = (p.x - cover.sx) * cover.scale;
      const y = (p.y - cover.sy) * cover.scale;
      if(MIRROR) x = canvas.width - x; // í™”ë©´ ë°˜ì „ê³¼ ë™ì¼í•˜ê²Œ í‚¤í¬ì¸íŠ¸ ì¢Œí‘œë„ ë°˜ì „
      return {x,y,score:p.score ?? p.confidence ?? 0};
    });
    return mapped;
  }
  function draw(k){ctx.lineWidth=3;ctx.strokeStyle='#84b6ff';
    const E=[[5,6],[5,7],[7,9],[6,8],[8,10],[5,11],[6,12],[11,12],[11,13],[13,15],[12,14],[14,16]];
    E.forEach(([a,b])=>{const pa=k[a],pb=k[b];if(pa&&pb&&(pa.score??0)>0.2&&(pb.score??0)>0.2){ctx.beginPath();ctx.moveTo(pa.x,pa.y);ctx.lineTo(pb.x,pb.y);ctx.stroke()}});
    k.forEach(p=>{if(p&&(p.score??0)>0.2){ctx.beginPath();ctx.fillStyle='#ffd166';ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill()}});
  }

  /* ===== ë¦¬ì‚¬ì´ì¦ˆ ===== */
  function resizeCanvasToVideo(){
    const vw = video.videoWidth || 1280, vh = video.videoHeight || 720;
    const cw = container.clientWidth;
    let ch = Math.round(cw * vh / vw);
    if(isMobile){ const maxH = Math.round(window.innerHeight * 0.7); if(ch > maxH) ch = maxH; }
    canvas.width = cw; canvas.height = ch;
    computeCover(canvas.width, canvas.height, vw, vh);
  }
  window.addEventListener('resize', ()=>{ if(video.srcObject) resizeCanvasToVideo(); });
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ if(video.srcObject) resizeCanvasToVideo(); }, 250); });

  /* ===== ëª¨ë¸/ì¹´ë©”ë¼ ===== */
  async function setupCam(facing='user'){
    $('#secureInfo').textContent='HTTPS: '+(window.isSecureContext?'OK':'í•„ìš”');
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('ë¸Œë¼ìš°ì €ê°€ ì¹´ë©”ë¼ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ');
    video.setAttribute('playsinline',''); video.setAttribute('webkit-playsinline',''); video.muted=true; video.autoplay=true;
    const constraints={video:{facingMode:facing, width:isMobile?640:1280, height:isMobile?360:720}, audio:false};
    const stream=await navigator.mediaDevices.getUserMedia(constraints); video.srcObject=stream;
    await new Promise((resolve)=>{ let done=false; const ok=()=>{if(done)return; done=true; resolve()};
      setTimeout(ok,5000); video.addEventListener('loadedmetadata',ok,{once:true}); video.addEventListener('canplay',ok,{once:true});
      video.play().then(ok).catch(()=>{video.muted=true; video.play().then(ok).catch(()=>{})}); });
    resizeCanvasToVideo();
  }
  async function initDetector(){ await tf.setBackend('webgl'); await tf.ready();
    const modelType=isMobile?'SinglePose.Lightning':'MultiPose.Lightning';
    detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType});
  }

  /* ===== íŠ¹ì§•/íŒì • ===== */
  function feats(ex,k){
    const LE=sel(k,KP.L_SHO), RE=sel(k,KP.R_SHO),
          LH=sel(k,KP.L_HIP), RH=sel(k,KP.R_HIP),
          LK=sel(k,KP.L_KNEE), RK=sel(k,KP.R_KNEE),
          LA=sel(k,KP.L_ANK),  RA=sel(k,KP.R_ANK);
    const tL=torso(LE,LH), tR=torso(RE,RH), T=(tL!=null&&tR!=null)?(tL+tR)/2:(tL??tR);

    if(ex==='lunge'){
      const f=[deg(LH,LK,LA),deg(RH,RK,RA),deg(LE,LH,LK),deg(RE,RH,RK),T];
      if(f.some(v=>v==null)) return null; return f.map(clamp);
    }
    if(ex==='knee_ext'){
      const Lh=deg(LE,LH,LK), Rh=deg(RE,RH,RK), Hip=(Lh!=null&&Rh!=null)?(Lh+Rh)/2:(Lh??Rh);
      const f=[deg(LH,LK,LA),deg(RH,RK,RA),Hip,T,(Lh??0)];
      if(f.slice(0,4).some(v=>v==null)) return null; return f.map(clamp);
    }
    if(ex==='sit_to_stand'){
      const kneeL = deg(LH,LK,LA), kneeR = deg(RH,RK,RA);
      const hipL  = deg(LE,LH,LK), hipR  = deg(RE,RH,RK);
      if([kneeL,kneeR,hipL,hipR,T].some(v=>v==null)) return null;
      return [clamp(kneeL),clamp(kneeR),clamp(hipL),clamp(hipR),clamp(T)];
    }
    return null;
  }
  function judge(ex,f){
    const s = loadAllMerged(ex);
    const dG=s.good.length?Math.min(...s.good.map(g=>MAE(f,g))):1e9;
    const dB=s.bad.length?Math.min(...s.bad.map(b=>MAE(f,b))):1e9;
    if(!s.good.length&&!s.bad.length) return {t:'ìƒ˜í”Œì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš” (G/B)',tone:'warn',dG,dB};
    if(dG<=THR_GOOD && dG+MARGIN<dB) return {t:'ì˜¬ë°”ë¥¸ ìì„¸ì…ë‹ˆë‹¤! ê³„ì†í•˜ì„¸ìš”!',tone:'ok',dG,dB};
    return {t:'í‹€ë¦° ìì„¸ì…ë‹ˆë‹¤. ìì„¸ë¥¼ ë°”ê¿”ì£¼ì„¸ìš”!',tone:'bad',dG,dB};
  }
  let ema=null; const ALPHA=.35;

  async function loop(){
    try{
      drawVideoCover();
      const poses=await detector.estimatePoses(
        video,
        { flipHorizontal: MIRROR, maxPoses: MAX_POSES, scoreThreshold:.25, nmsRadius:20 }
      );
      if(!poses?.length){setStatus('ì‚¬ëŒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì „ì‹ ì´ ë‚˜ì˜¤ê²Œ ì„œì£¼ì„¸ìš”.','warn');debugEl.textContent='';return requestAnimationFrame(loop)}
      if(!isMobile && poses.length!==1){setStatus('ì‚¬ëŒì´ ì—¬ëŸ¬ëª… ìˆìŠµë‹ˆë‹¤. í•œ ëª…ë§Œ ë‚˜ì˜¤ê²Œ í•´ì£¼ì„¸ìš”.','warn');
        poses.forEach(p=>draw(mapKeypoints(p))); debugEl.textContent=`detect:${poses.length}`; return requestAnimationFrame(loop);}
      const k = mapKeypoints(poses[0]); draw(k);

      const f=feats(EX,k); if(!f){setStatus('ê´€ì ˆ ì‹ ë¢°ë„ê°€ ë‚®ìŠµë‹ˆë‹¤. ì „ì‹ ì´ ë³´ì´ê²Œ ì„œì£¼ì„¸ìš”.','warn');debugEl.textContent='';return requestAnimationFrame(loop)}
      const v=judge(EX,f);
      ema=(ema==null)?(v.tone==='ok'?1:0):(ALPHA*(v.tone==='ok'?1:0)+(1-ALPHA)*ema);
      const tone=ema>0.6?'ok':(ema<0.4?'bad':v.tone);
      setStatus(v.t,tone);
      const base = DEFAULT_SAMPLES[EX]||{good:[],bad:[]};
      const cloud = cloudCache[EX]||{good:[],bad:[]};
      debugEl.textContent=`ê±°ìš¸:${MIRROR?'ON':'OFF'} â€¢ ìš´ë™:${exSel.options[exSel.selectedIndex].text} â€¢ dG:${v.dG?.toFixed?.(1)??'-'} â€¢ dB:${v.dB?.toFixed?.(1)??'-'} â€¢ baseG:${base.good.length} baseB:${base.bad.length} â€¢ cloud:${cloud.good.length+cloud.bad.length}`;
    }catch(e){console.error(e);setStatus('ì¶”ë¡  ì˜¤ë¥˜: '+(e?.message||e),'bad')}
    requestAnimationFrame(loop);
  }

  /* ===== ì‹œì‘/ì´ë²¤íŠ¸ ===== */
  async function start(){
    try{
      setStatus('ì¹´ë©”ë¼ ì—°ê²° ì¤‘â€¦'); await setupCam();
      setStatus('ëª¨ë¸ ë¡œë”© ì¤‘â€¦');  await initDetector();
      await loadCloudOnce(EX);
      updateCounts();
      setStatus('ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ â€“ ë°”ë¡œ ì‹œì—° ê°€ëŠ¥'); loop();
    }catch(e){
      console.error(e); setStatus('ì´ˆê¸°í™” ì‹¤íŒ¨: '+(e?.message||e),'bad');
      $('#starter').style.display='flex'; showToast('ì´ˆê¸°í™” ì‹¤íŒ¨. ê¶Œí•œ/HTTPS/ë³´ì•ˆ ì•± í™•ì¸');
    }
  }
  $('#btnStart').onclick=()=>{ $('#starter').style.display='none'; start(); };
  if(!isMobile) start();

  let facing='user';
  $('#flipCam').onclick=async()=>{ video.srcObject?.getTracks()?.forEach(t=>t.stop()); facing=(facing==='user')?'environment':'user'; await setupCam(facing); };

  async function snap(type){
    if(!(await ensureAuth('ìƒ˜í”Œ ì €ì¥(í•™ìŠµ)'))) return;
    const poses=await detector.estimatePoses(video,{flipHorizontal:MIRROR,maxPoses:MAX_POSES});
    if(!poses?.length){showToast('ì‚¬ëŒì´ ì¸ì‹ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤');return;}
    const k = mapKeypoints(poses[0]);
    const f=feats(EX, k); if(!f){showToast('ê´€ì ˆ ì‹ ë¢°ë„ ë‚®ìŒ');return;}
    addLocal(EX,type,f);
    await addCloud(EX,type,f);
    showToast(type==='good'?'ì¢‹ì€ ìƒ˜í”Œ ì €ì¥(ë¡œì»¬+ê³µìœ ) ì™„ë£Œ':'ë‚˜ìœ ìƒ˜í”Œ ì €ì¥(ë¡œì»¬+ê³µìœ ) ì™„ë£Œ');
  }
  $('#btn-good').onclick=()=>snap('good');
  $('#btn-bad').onclick =()=>snap('bad');

  // ë‹¨ì¶•í‚¤: G/B
  window.addEventListener('keydown',e=>{
    if(e.key==='g'||e.key==='G') $('#btn-good').click();
    if(e.key==='b'||e.key==='B') $('#btn-bad').click();
  });

  // ê³µìœ  ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”: 3ë‹¨ ê²½ê³  + ë¹„ë°€ë²ˆí˜¸
  async function tripleDangerReset(){
    if(!(await ensureAuth('ê³µìœ  ë°ì´í„° ì „ì²´ ì´ˆê¸°í™”'))) return;

    if(!confirm('âš ï¸ [1/3] ê³µìœ  ë°ì´í„°(ëª¨ë“  ìš´ë™ì˜ í´ë¼ìš°ë“œ ìƒ˜í”Œ)ë¥¼ ì „ë¶€ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í•©ë‹ˆê¹Œ?')) return;
    const word = prompt('âš ï¸ [2/3] ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³„ì†í•˜ë ¤ë©´ ëŒ€ë¬¸ìë¡œ DELETE ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
    if(word !== 'DELETE'){ showToast('ì·¨ì†Œë¨'); return; }
    if(!confirm('âš ï¸ [3/3] ì •ë§ ì§„í–‰í• ê¹Œìš”? ì´ ì‘ì—…ì€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•©ë‹ˆë‹¤.')) return;

    try{
      await fbDelete(`/rehab_samples`);
      Object.keys(cloudCache).forEach(k=>{ cloudCache[k]={good:[],bad:[]} });
      updateCounts();
      showToast('ê³µìœ  ë°ì´í„° ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
    }catch(e){
      console.error(e); showToast('ê³µìœ  ì´ˆê¸°í™” ì‹¤íŒ¨(ê¶Œí•œ/ê·œì¹™ í™•ì¸)');
    }
  }
  $('#btn-reset-cloud').onclick = tripleDangerReset;

  exSel.addEventListener('change', async ()=>{
    EX=exSel.value; localStorage.setItem('last_ex',EX);
    const tagEl = $('#ex-tag'); if(tagEl) tagEl.textContent=exSel.options[exSel.selectedIndex].text;
    await loadCloudOnce(EX);
    updateCounts(); ema=null; showToast('ìš´ë™ ë³€ê²½');
  });
  </script>
</body>
</html>
