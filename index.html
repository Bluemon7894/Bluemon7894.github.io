<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>헬핏 재활 자세 데모</title>
<meta name="color-scheme" content="dark">
<style>
  :root{
    --bg:#070a12;--panel:#0e1421f2;--muted:#9fb0c3;--line:#25324b;--brand:#8ec5ff;
    --ok:#28d790;--warn:#ffcc66;--bad:#ff7a9e;--chip:#14233a;--card:#0b1220d9;
    --shadow:0 10px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
    --round:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Pretendard,sans-serif;
    color:#eaf2ff; background:
      radial-gradient(1200px 600px at 10% -10%, #0f2a5a44, transparent),
      radial-gradient(1100px 600px at 90% 0%, #3b138a33, transparent),
      linear-gradient(180deg, #0a0f1e 0%, #070a12 60%, #070a12 100%);
    min-height:100vh;
  }
  /* Header */
  header{
    position:sticky; top:0; z-index:30; border-bottom:1px solid #18243a;
    backdrop-filter: blur(10px);
    background:linear-gradient(90deg,#0a1224cc,#0b0f1ecc 60%,#0a1224cc);
  }
  .nav{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
  .brand{
    display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.2px;
    background:linear-gradient(90deg,#9bd0ff,#caa8ff);-webkit-background-clip:text;background-clip:text;color:transparent;
    font-size:18px
  }
  .chip{margin-left:8px;padding:6px 10px;border-radius:999px;background:var(--chip);
    border:1px solid #244065;color:var(--brand);font-weight:700}
  .status{margin-left:auto;padding:8px 12px;border-radius:12px;border:1px solid #1f2e4b;background:#0f1627;color:#cfe2ff;font-weight:800}
  .status.ok{background:#0d1f1a;border-color:#266a4e;color:var(--ok)}
  .status.warn{background:#20180d;border-color:#7a5a1f;color:var(--warn)}
  .status.bad{background:#211018;border-color:#6e223f;color:var(--bad)}
  /* Layout */
  .wrap{max-width:1200px;margin:22px auto;padding:0 18px}
  .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:18px}
  @media (max-width: 1024px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--round);box-shadow:var(--shadow)}
  .card-body{padding:16px}
  /* Stage */
  #canvas{width:100%;aspect-ratio:16/9;border-radius:14px;background:#000;display:block}
  #video{display:none}
  .stage-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .stage-title{font-weight:800}
  .pill{padding:6px 10px;border-radius:999px;background:#0f1a2a;border:1px solid #2a3b58;color:#cfe2ff;font-weight:700}
  /* Right panel */
  .stack{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row-spread{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  select,.btn,.btn-ghost{
    padding:10px 12px;border-radius:12px;border:1px solid #2a3b58;background:#0e1626;color:#e7f1ff;font-weight:800
  }
  .btn{background:linear-gradient(180deg,#1a3a6b,#122240); border-color:#2b4777}
  .btn:hover{filter:brightness(1.08)}
  .btn.ok{background:linear-gradient(180deg,#1c4d3a,#113424);border-color:#2b7a58}
  .btn.bad{background:linear-gradient(180deg,#5a2133,#2a1120);border-color:#80304b}
  .btn-ghost{background:#0c1322}
  .count{padding:4px 10px;border-radius:999px;background:#0f1a2a;border:1px solid #2b4777;color:#9ecbff;font-weight:900}
  label{font-size:12px;color:var(--muted)}
  .muted{color:var(--muted);font-size:13px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:#b9c7da}
  /* Footer flair */
  .footer{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width: 900px){ .footer{grid-template-columns:1fr} }
  .tip,.credit{background:var(--panel);border:1px solid var(--line);border-radius:var(--round);padding:14px;box-shadow:var(--shadow)}
  .tip h4{margin:0 0 8px}
  .tag{padding:4px 10px;border-radius:999px;background:#111b2a;border:1px solid #294164;color:#9ecbff;font-weight:800}
  /* Toast */
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;
    background:#0f1627;border:1px solid #2a3b58;border-radius:12px;padding:10px 14px;color:#cfe2ff;box-shadow:var(--shadow);
    transition:all .28s ease;z-index:40;font-weight:800}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  /* Mobile Block */
  #mobileBlock{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50;
    backdrop-filter:blur(8px);background:#070a12dd}
  #mobileCard{width:min(520px,92vw);background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;text-align:center}
  #mobileCard h2{margin:.2rem 0 .5rem}
  /* Loading spinner */
  .spin{width:16px;height:16px;border-radius:50%;border:3px solid #2a3b58;border-top-color:#9ecbff;display:inline-block;animation:rot .8s linear infinite;margin-right:6px}
  @keyframes rot{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">HELFIT • Pose Coach</div>
      <div class="chip">MoveNet (TF.js)</div>
      <div id="status" class="status"><span class="spin"></span>초기화 중…</div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Stage -->
      <section class="card">
        <div class="card-body">
          <div class="stage-head">
            <div class="stage-title">카메라</div>
            <div class="pill" id="secureInfo">HTTPS: 확인 중…</div>
          </div>
          <canvas id="canvas" width="960" height="540"></canvas>
          <video id="video" playsinline muted></video>
        </div>
      </section>

      <!-- Right panel -->
      <aside class="card">
        <div class="card-body stack">
          <div class="row-spread">
            <div>
              <label for="exercise">운동 선택</label><br/>
              <select id="exercise">
                <option value="squat">스쿼트</option>
                <option value="lunge">런지</option>
                <option value="arm_raise">팔 올리기</option>
                <option value="knee_ext">무릎 신전</option>
              </select>
            </div>
            <div class="row" style="gap:6px">
              <div class="count" title="좋은 샘플">G: <span id="cnt-good">0</span></div>
              <div class="count" title="나쁜 샘플">B: <span id="cnt-bad">0</span></div>
            </div>
          </div>

          <div class="row">
            <button class="btn ok" id="btn-good">좋은 샘플 저장 (G)</button>
            <button class="btn bad" id="btn-bad">나쁜 샘플 저장 (B)</button>
            <button class="btn-ghost" id="btn-reset">초기화 (R)</button>
          </div>

          <div class="tip">
            <h4>설명</h4>
            <div class="muted">카메라 → <b>MoveNet</b> 17 키포인트 → 동작별 <b>관절각 특징</b> → 샘플 유사도 → 피드백.</div>
          </div>

          <div class="mono" id="debug"></div>
        </div>
      </aside>
    </div>

    <!-- Footer tips -->
    <div class="footer">
      <div class="tip">
        <h4>데모 팁</h4>
        <ul class="muted" style="margin:6px 0 0 18px">
          <li><b>한 명만</b> 화면에 나오게 해주세요. 여러 명 감지 시 판정을 멈춥니다.</li>
          <li><b>전신</b>이 보이도록 1.5~2m 거리에서 촬영하면 정확도가 좋아요.</li>
          <li>동작마다 <b>G/B</b>로 각 5~10장 저장하면 안정적입니다.</li>
        </ul>
      </div>
      <div class="credit">
        <div class="row-spread">
          <div class="muted">현재 운동: <span class="tag" id="ex-tag">스쿼트</span></div>
          <div class="muted">샘플 저장소: <span class="tag">localStorage</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Block -->
  <div id="mobileBlock">
    <div id="mobileCard">
      <h2>해당 서비스는 현재 <span style="color:#9ecbff">PC</span>로만 사용 가능합니다</h2>
      <p class="muted">불편을 드려 죄송합니다. 데스크톱/노트북에서 접속해 주세요.</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">메시지</div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script>
  /* ---------- UX helpers ---------- */
  const $ = (q)=>document.querySelector(q);
  const statusEl = $('#status');
  const toast = $('#toast');
  const setStatus = (t, tone='')=>{
    statusEl.className = 'status ' + tone;
    statusEl.innerHTML = (tone? '' : '<span class="spin"></span>') + t;
  };
  const showToast = (t, ms=1400)=>{
    toast.textContent = t;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), ms);
  };

  /* ---------- Mobile block (allow ?force=1) ---------- */
  const FORCE = new URLSearchParams(location.search).get('force')==='1';
  const uaMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const blockMobile = uaMobile && !FORCE;
  if(blockMobile) $('#mobileBlock').style.display='flex';

  /* ---------- Elements & state ---------- */
  const video=$('#video'), canvas=$('#canvas'), ctx=canvas.getContext('2d');
  const cntG=$('#cnt-good'), cntB=$('#cnt-bad'), exSel=$('#exercise'), exTag=$('#ex-tag'), debugEl=$('#debug');
  const KP={NOSE:0,L_EYE:1,R_EYE:2,L_EAR:3,R_EAR:4,L_SHO:5,R_SHO:6,L_ELB:7,R_ELB:8,L_WR:9,R_WR:10,L_HIP:11,R_HIP:12,L_KNEE:13,R_KNEE:14,L_ANK:15,R_ANK:16};
  const CONF_THR=0.2, MAX_SAMPLES=250, THR_GOOD=8.0, MARGIN=2.0, MAX_POSES=4;
  let detector, EX=localStorage.getItem('last_ex')||'squat';
  exSel.value=EX; exTag.textContent=exSel.options[exSel.selectedIndex].text;

  /* ---------- Sample store ---------- */
  const key=(ex)=>`rehab_${ex}_samples_v1`;
  const load=ex=>{ try{const o=JSON.parse(localStorage.getItem(key(ex))||'{}'); return {good:o.good||[],bad:o.bad||[]};}catch{return{good:[],bad:[]}} };
  const save=(ex,o)=>localStorage.setItem(key(ex),JSON.stringify(o));
  const add=(ex,t,f)=>{ const s=load(ex); s[t]=[...s[t],f].slice(-MAX_SAMPLES); save(ex,s); updCount(); };
  const clearS=(ex)=>{ save(ex,{good:[],bad:[]}); updCount(); };
  const updCount=()=>{ const s=load(EX); cntG.textContent=s.good.length; cntB.textContent=s.bad.length; };

  /* ---------- Math/feature ---------- */
  const sel=(k,i)=>{const p=k[i];const s=p?.score??p?.confidence??0;return s<CONF_THR?null:{x:p.x,y:p.y,score:s}};
  const deg=(a,b,c)=>{ if(!a||!b||!c)return null; const v1=[a.x-b.x,a.y-b.y],v2=[c.x-b.x,c.y-b.y];const n1=Math.hypot(...v1),n2=Math.hypot(...v2); if(!n1||!n2)return null; let cos=(v1[0]*v2[0]+v1[1]*v2[1])/(n1*n2); cos=Math.max(-1,Math.min(1,cos)); return Math.acos(cos)*180/Math.PI; };
  const torso=(s,h)=>{ if(!s||!h)return null; const vx=h.x-s.x,vy=h.y-s.y,n=Math.hypot(vx,vy); if(!n)return null; let cos=vy/n; cos=Math.max(-1,Math.min(1,cos)); return Math.acos(cos)*180/Math.PI; };
  const MAE=(a,b)=>a.reduce((s,v,i)=>s+Math.abs(v-b[i]),0)/a.length;

  function feats(ex,k){
    const LE=sel(k,5), RE=sel(k,6), LH=sel(k,11), RH=sel(k,12), LK=sel(k,13), RK=sel(k,14), LA=sel(k,15), RA=sel(k,16),
          LW=sel(k,9), RW=sel(k,10), LEb=sel(k,7), REb=sel(k,8);
    const tL=torso(LE,LH), tR=torso(RE,RH), T=(tL!=null&&tR!=null)?(tL+tR)/2:(tL??tR);
    if(ex==='squat'||ex==='lunge'){ const Lk=deg(LH,LK,LA), Rk=deg(RH,RK,RA), Lh=deg(LE,LH,LK), Rh=deg(RE,RH,RK);
      const f=[Lk,Rk,Lh,Rh,T]; if(f.some(v=>v==null)) return null; return f.map(v=>Math.max(0,Math.min(180,v))); }
    if(ex==='arm_raise'){ const La=deg(LE,LEb,LW), Ra=deg(RE,REb,RW), Lh=deg(LE,LH,LK), Rh=deg(RE,RH,RK);
      const f=[La,Ra,Lh,Rh,T]; if(f.some(v=>v==null)) return null; return f.map(v=>Math.max(0,Math.min(180,v))); }
    if(ex==='knee_ext'){ const Lk=deg(LH,LK,LA), Rk=deg(RH,RK,RA), Lh=deg(LE,LH,LK), Rh=deg(RE,RH,RK), Hip=(Lh!=null&&Rh!=null)?(Lh+Rh)/2:(Lh??Rh);
      const f=[Lk,Rk,Hip,T,(Lh??0)]; if(f.slice(0,4).some(v=>v==null)) return null; return f.map(v=>Math.max(0,Math.min(180,v))); }
    return null;
  }
  const judge=(ex,f)=>{ const s=load(ex); const dG=s.good.length?Math.min(...s.good.map(g=>MAE(f,g))):1e9; const dB=s.bad.length?Math.min(...s.bad.map(b=>MAE(f,b))):1e9;
    if(!s.good.length&&!s.bad.length) return {t:'샘플을 먼저 저장하세요 (G/B)', tone:'warn', dG,dB};
    if(dG<=THR_GOOD && dG+MARGIN<dB) return {t:'올바른 자세입니다! 계속하세요!', tone:'ok', dG,dB};
    return {t:'틀린 자세입니다. 자세를 바꿔주세요!', tone:'bad', dG,dB};
  };

  /* ---------- Drawing ---------- */
  const E=[[5,6],[5,7],[7,9],[6,8],[8,10],[5,11],[6,12],[11,12],[11,13],[13,15],[12,14],[14,16]];
  function draw(k){ ctx.lineWidth=3; ctx.strokeStyle='#84b6ff';
    E.forEach(([a,b])=>{ const pa=k[a],pb=k[b]; if(pa&&pb&&(pa.score??0)>CONF_THR&&(pb.score??0)>CONF_THR){ ctx.beginPath(); ctx.moveTo(pa.x,pa.y); ctx.lineTo(pb.x,pb.y); ctx.stroke(); }});
    k.forEach(p=>{ if(p&&(p.score??0)>CONF_THR){ ctx.beginPath(); ctx.fillStyle='#ffd166'; ctx.arc(p.x,p.y,4,0,Math.PI*2); ctx.fill(); }});
  }
  const scale=(pose)=>{ const vW=video.videoWidth||canvas.width,vH=video.videoHeight||canvas.height; const sx=canvas.width/vW, sy=canvas.height/vH;
    return pose.keypoints.map(k=>({x:k.x*sx,y:k.y*sy,score:k.score??k.confidence??0})); };

  /* ---------- Camera / Detector ---------- */
  async function setupCam(){
    $('#secureInfo').textContent = 'HTTPS: ' + (window.isSecureContext?'OK':'필요');
    if (!navigator.mediaDevices?.getUserMedia) throw new Error('브라우저가 카메라 API를 지원하지 않음');
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user',width:1280,height:720},audio:false});
    video.srcObject=stream;
    await new Promise(res=>video.onloadedmetadata=res);
    await video.play();
  }

  async function start(){
    try{
      if(blockMobile){ setStatus('모바일 접속 차단됨. PC에서 이용하거나 ?force=1 로 무시 가능', 'warn'); return; }
      setStatus('카메라 연결 중…');
      await setupCam();

      setStatus('모델 로딩 중…');
      detector = await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType:'MultiPose.Lightning'});

      updCount(); setStatus('카메라 준비 완료 – 샘플(G/B)을 몇 장 저장해 보세요','');
      loop();
    }catch(e){
      console.error(e);
      setStatus('초기화 실패: '+(e?.message||e), 'bad');
      showToast('초기화 실패. 주소창 카메라 권한/HTTPS/보안SW 확인');
    }
  }

  async function loop(){
    try{
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const poses = await detector.estimatePoses(video,{flipHorizontal:false,maxPoses:MAX_POSES,scoreThreshold:.25,nmsRadius:20});
      if(!poses?.length){ setStatus('사람을 찾지 못했습니다. 전신이 나오게 서주세요.','warn'); debugEl.textContent=''; return requestAnimationFrame(loop); }
      if(poses.length!==1){
        setStatus('사람이 여러명 있습니다. 한 명만 나오게 해주세요.','warn');
        const all=poses.map(scale); ctx.save(); ctx.globalAlpha=.85; all.forEach(draw); ctx.restore();
        debugEl.textContent=`detect:${poses.length}`; return requestAnimationFrame(loop);
      }
      const k=scale(poses[0]); draw(k);
      const f=feats(EX,k);
      if(!f){ setStatus('관절 신뢰도가 낮습니다. 전신이 보이게 서주세요.','warn'); debugEl.textContent=''; return requestAnimationFrame(loop); }
      const v=judge(EX,f); setStatus(v.t, v.tone);
      debugEl.textContent=`운동:${exSel.options[exSel.selectedIndex].text} • dG:${v.dG?.toFixed?.(1)??'-'} • dB:${v.dB?.toFixed?.(1)??'-'} • ${new Date().toLocaleTimeString()}`;
    }catch(e){
      console.error(e); setStatus('추론 오류: '+(e?.message||e),'bad');
    }
    requestAnimationFrame(loop);
  }

  /* ---------- Save samples ---------- */
  async function snap(type){
    const poses = await detector.estimatePoses(video,{flipHorizontal:false,maxPoses:MAX_POSES});
    if(!poses || poses.length!==1){ showToast('한 명만 나오게 해주세요'); return; }
    const f=feats(EX, scale(poses[0]));
    if(!f){ showToast('관절 신뢰도 낮음'); return; }
    add(EX, type, f);
    showToast(type==='good'?'좋은 샘플 저장 완료':'나쁜 샘플 저장 완료');
  }

  /* ---------- Events ---------- */
  $('#btn-good').onclick=()=>snap('good');
  $('#btn-bad').onclick =()=>snap('bad');
  $('#btn-reset').onclick=()=>{ clearS(EX); showToast('샘플 초기화 완료'); };
  window.addEventListener('keydown',e=>{
    if(e.key==='g'||e.key==='G')$('#btn-good').click();
    if(e.key==='b'||e.key==='B')$('#btn-bad').click();
    if(e.key==='r'||e.key==='R')$('#btn-reset').click();
  });
  exSel.addEventListener('change',()=>{
    EX=exSel.value; localStorage.setItem('last_ex',EX); updCount();
    exTag.textContent = exSel.options[exSel.selectedIndex].text;
    showToast('운동 변경: '+exTag.textContent);
  });

  /* ---------- Go ---------- */
  start();
  </script>
</body>
</html>
