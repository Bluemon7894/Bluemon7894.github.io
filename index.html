<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>헬핏 재활 자세 데모</title>
<meta name="color-scheme" content="dark">
<link rel="icon" type="image/png" href="helfit%20logo.png">
<style>
  :root{--bg:#070a12;--panel:#0e1421f2;--muted:#9fb0c3;--line:#25324b;--brand:#8ec5ff;--ok:#28d790;--warn:#ffcc66;--bad:#ff7a9e;--chip:#14233a;--card:#0b1220d9;--shadow:0 10px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);--round:18px}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,Apple SD Gothic Neo,Segoe UI,Roboto,Pretendard,sans-serif;color:#eaf2ff;background:
    radial-gradient(1200px 600px at 10% -10%, #0f2a5a44, transparent),
    radial-gradient(1100px 600px at 90% 0%, #3b138a33, transparent),
    linear-gradient(180deg,#0a0f1e 0%,#070a12 60%,#070a12 100%)}
  header{position:sticky;top:0;z-index:30;border-bottom:1px solid #18243a;backdrop-filter:blur(10px);background:linear-gradient(90deg,#0a1224cc,#0b0f1ecc 60%,#0a1224cc)}
  .nav{max-width:1200px;margin:0 auto;padding:14px 18px;display:flex;gap:12px;align-items:center}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
  #logo{height:28px;width:auto;display:block;filter:drop-shadow(0 1px 2px rgba(0,0,0,.35))}
  .chip{margin-left:8px;padding:6px 10px;border-radius:999px;background:#14233a;border:1px solid #244065;color:#8ec5ff;font-weight:700}
  .status{margin-left:auto;padding:8px 12px;border-radius:12px;border:1px solid #1f2e4b;background:#0f1627;color:#cfe2ff;font-weight:800}
  .status.ok{background:#0d1f1a;border-color:#266a4e;color:var(--ok)}
  .status.warn{background:#20180d;border-color:#7a5a1f;color:var(--warn)}
  .status.bad{background:#211018;border-color:#6e223f;color:var(--bad)}
  .wrap{max-width:1200px;margin:22px auto;padding:0 18px}
  .grid{display:grid;grid-template-columns:1.25fr .75fr;gap:18px}
  @media (max-width:1024px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--round);box-shadow:var(--shadow)}
  .card-body{padding:16px}
  #canvas{width:100%;height:auto;border-radius:14px;background:#000;display:block}
  #video{display:none}
  .stage-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .stage-title{font-weight:800}
  .pill{padding:6px 10px;border-radius:999px;background:#0f1a2a;border:1px solid #2a3b58;color:#cfe2ff;font-weight:700}
  .stack{display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row-spread{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  select,.btn,.btn-ghost{padding:10px 12px;border-radius:12px;border:1px solid #2a3b58;background:#0e1626;color:#e7f1ff;font-weight:800}
  .btn{background:linear-gradient(180deg,#1a3a6b,#122240);border-color:#2b4777}
  .btn:hover{filter:brightness(1.08)}
  .btn.ok{background:linear-gradient(180deg,#1c4d3a,#113424);border-color:#2b7a58}
  .btn.bad{background:linear-gradient(180deg,#5a2133,#2a1120);border-color:#80304b}
  .btn-ghost{background:#0c1322}
  .count{padding:4px 10px;border-radius:999px;background:#0f1a2a;border:1px solid #2b4777;color:#9ecbff;font-weight:900}
  label{font-size:12px;color:#9fb0c3}
  .muted{color:#9fb0c3;font-size:13px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:#b9c7da}
  .footer{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:900px){.footer{grid-template-columns:1fr}}
  .tip,.credit{background:#0e1421f2;border:1px solid #25324b;border-radius:var(--round);padding:14px;box-shadow:var(--shadow)}
  .tip h4{margin:0 0 8px}
  .tag{padding:4px 10px;border-radius:999px;background:#111b2a;border:1px solid #294164;color:#9ecbff;font-weight:800}
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);opacity:0;background:#0f1627;border:1px solid #2a3b58;border-radius:12px;padding:10px 14px;color:#cfe2ff;box-shadow:var(--shadow);transition:all .28s ease;z-index:40;font-weight:800}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  #starter{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#070a12ee;z-index:99}
  #starter .panel{background:#0e1421f2;border:1px solid #25324b;border-radius:16px;padding:18px;box-shadow:var(--shadow);text-align:center}
  .spin{width:16px;height:16px;border-radius:50%;border:3px solid #2a3b58;border-top-color:#9ec5ff;display:inline-block;animation:rot .8s linear infinite;margin-right:6px}
  @keyframes rot{to{transform:rotate(360deg)}}
</style>
</head>
<body>
  <header>
    <div class="nav">
      <a class="brand" href="./" aria-label="헬핏 홈">
        <img id="logo" src="helfit%20logo.png" alt="헬핏 로고">
      </a>
      <div class="chip">MoveNet (TF.js)</div>
      <div id="status" class="status"><span class="spin"></span>초기화 중…</div>
    </div>
  </header>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <div class="card-body">
          <div class="stage-head">
            <div class="stage-title">카메라</div>
            <div class="pill" id="secureInfo">HTTPS: 확인 중…</div>
          </div>
          <canvas id="canvas" width="960" height="540"></canvas>
          <video id="video" playsinline webkit-playsinline muted autoplay></video>
        </div>
      </section>

      <aside class="card">
        <div class="card-body stack">
          <div class="row-spread">
            <div>
              <label for="exercise">운동 선택</label><br/>
              <select id="exercise">
                <option value="lunge">런지</option>
                <option value="knee_ext">무릎 신전</option>
                <option value="sit_to_stand">앉았다 일어나기</option>
              </select>
            </div>
            <div class="row" style="gap:6px">
              <div class="count" title="좋은 샘플">G: <span id="cnt-good">0</span></div>
              <div class="count" title="나쁜 샘플">B: <span id="cnt-bad">0</span></div>
              <div class="count" title="공유(원격) 샘플">Cloud: <span id="cnt-cloud">0</span></div>
            </div>
          </div>

          <div class="row">
            <button class="btn ok" id="btn-good" title="단축키 G">좋은 샘플 저장 (G)</button>
            <button class="btn bad" id="btn-bad" title="단축키 B">나쁜 샘플 저장 (B)</button>
            <button class="btn-ghost" id="btn-reset-cloud" title="공유 데이터 전체 초기화">공유 데이터 전체 초기화</button>
            <button class="btn-ghost" id="flipCam" style="display:none">전/후면 전환</button>
          </div>

          <div class="tip">
            <h4>설명</h4>
            <div class="muted">카메라 → <b>MoveNet</b> → 동작별 <b>관절각 특징</b> → <b>기본 + 로컬 + 공유(Firebase)</b> 유사도 → 피드백.<br/>G/B 저장 시 로컬+클라우드에 동시 저장됩니다. (거울 모드 ON)</div>
          </div>

          <div class="mono" id="debug"></div>
        </div>
      </aside>
    </div>

    <div class="footer">
      <div class="tip">
        <h4>데모 팁</h4>
        <ul class="muted" style="margin:6px 0 0 18px">
          <li><b>한 명만</b> 화면에 나오게 해주세요.</li>
          <li><b>전신</b>이 보이도록 1.5~2m 거리에서 촬영하면 정확도가 좋아요.</li>
        </ul>
      </div>
      <div class="credit">
        <div class="row-spread">
          <div class="muted">현재 운동: <span class="tag" id="ex-tag">런지</span></div>
          <div class="muted">샘플: <span class="tag">기본 + 로컬 + 공유(Firebase)</span></div>
        </div>
      </div>
    </div>
  </div>

  <div id="starter">
    <div class="panel">
      <h3 style="margin:0 0 8px">헬핏 재활 자세 데모</h3>
      <p class="muted" style="margin:0 0 14px">카메라 권한을 허용하고 아래 버튼을 누르면 시작합니다.</p>
      <button id="btnStart" class="btn">카메라 시작</button>
      <div class="muted" style="margin-top:8px;font-size:12px">문제가 지속되면 다른 브라우저(크롬/사파리)로 시도</div>
    </div>
  </div>

  <div id="toast" class="toast">메시지</div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>

  <script>
  /* ===== 설정 ===== */
  const MIRROR = true; // 거울 모드 ON

  /* ===== 공통 ===== */
  const $ = s=>document.querySelector(s);
  const statusEl = $('#status'), toast=$('#toast');
  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  const video=$('#video'), canvas=$('#canvas'), ctx=canvas.getContext('2d');
  const container = canvas.parentElement;

  function setStatus(t,tone=''){ statusEl.className='status '+tone; statusEl.innerHTML=(tone?'':'<span class="spin"></span>')+t; }
  function showToast(t,ms=1800){ toast.textContent=t; toast.classList.add('show'); clearTimeout(showToast._t); showToast._t=setTimeout(()=>toast.classList.remove('show'),ms); }
  if(isMobile) $('#starter').style.display='flex'; else $('#starter').style.display='none';
  if(isMobile) $('#flipCam').style.display='inline-block';

  /* ===== 간이 비밀번호 보호(세션 단위) ===== */
  const ADMIN_PASSWORD = 'Bluemon7894';
  let isAuthed = false;
  async function ensureAuth(reason='보호된 작업'){
    if(isAuthed) return true;
    const pw = prompt(`🔒 ${reason}을(를) 수행하려면 비밀번호를 입력하세요.`);
    if(pw === ADMIN_PASSWORD){ isAuthed = true; showToast('인증 성공'); return true; }
    showToast('인증 실패'); return false;
  }

  /* ===== Firebase ===== */
  const FIREBASE_BASE = 'https://helfit-rehab-default-rtdb.asia-southeast1.firebasedatabase.app';

  async function fbGet(path) {
    const url = `${FIREBASE_BASE}${path}.json`;
    const res = await fetch(url, { method:'GET', mode:'cors' });
    const text = await res.text();
    if(!res.ok){ console.error('Firebase GET 실패:', res.status, text); throw new Error(`Firebase GET 실패 ${res.status}`); }
    try { return JSON.parse(text); } catch { return null; }
  }
  async function fbPost(path, data) {
    const url = `${FIREBASE_BASE}${path}.json`;
    const res = await fetch(url, {
      method:'POST',
      mode:'cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const text = await res.text();
    if(!res.ok){ console.error('Firebase POST 실패:', res.status, text); throw new Error(`Firebase POST 실패 ${res.status}`); }
    try { return JSON.parse(text); } catch { return null; }
  }
  async function fbDelete(path) {
    const url = `${FIREBASE_BASE}${path}.json`;
    const res = await fetch(url, { method:'DELETE', mode:'cors' });
    const text = await res.text();
    if(!res.ok){ console.error('Firebase DELETE 실패:', res.status, text); throw new Error(`Firebase DELETE 실패 ${res.status}`); }
    return true;
  }

  /* ===== 기본 샘플(세 동작) ===== */
  const DEFP={
    lunge:{good:{LK:[95,15],RK:[95,15],LH:[80,15],RH:[80,15],T:[25,10]},
           bad :{LK:[40,15],RK:[140,15],LH:[30,15],RH:[120,15],T:[5,8]}},
    knee_ext:{good:{LK:[175,6],RK:[175,6],LH:[170,8],RH:[170,8],T:[8,6]},
              bad :{LK:[120,20],RK:[120,20],LH:[130,20],RH:[130,20],T:[25,12]}},
    sit_to_stand:{good:{LK:[175,8],RK:[175,8],LH:[170,10],RH:[170,10],T:[10,8]},
                  bad :{LK:[90,20],RK:[90,20],LH:[120,20],RH:[120,20],T:[28,12]}}
  };
  const clamp=v=>Math.max(0,Math.min(180,v));
  function expand(spec,k=3){
    const R=([c,d])=>k===1?[c]:(k===2?[c-d,c+d]:[c-d,c,c+d]);
    const A=R(spec.LK),B=R(spec.RK),C=R(spec.LH),D=R(spec.RH),E=R(spec.T),out=[];
    for(const a of A)for(const b of B)for(const c of C)for(const d of D)for(const e of E) out.push([clamp(a),clamp(b),clamp(c),clamp(d),clamp(e)]);
    return dedup(out,3.0)
  }
  function dedup(list,thr){const o=[];list.forEach(v=>{const same=o.some(u=>v.reduce((s,x,i)=>s+Math.abs(x-u[i]),0)/v.length<thr);if(!same)o.push(v)});return o}
  const DEFAULT_SAMPLES=['lunge','knee_ext','sit_to_stand']
    .reduce((a,e)=>(a[e]={good:expand(DEFP[e].good,3),bad:expand(DEFP[e].bad,2)},a),{});

  /* ===== 상태/파라미터 ===== */
  const cntG=$('#cnt-good'),cntB=$('#cnt-bad'),cntC=$('#cnt-cloud');
  const exSel=$('#exercise'),exTag=$('#ex-tag'),debugEl=$('#debug');
  const KP={NOSE:0,L_EYE:1,R_EYE:2,L_EAR:3,R_EAR:4,L_SHO:5,R_SHO:6,L_ELB:7,R_ELB:8,L_WR:9,R_WR:10,L_HIP:11,R_HIP:12,L_KNEE:13,R_KNEE:14,L_ANK:15,R_ANK:16};
  const CONF_THR=.2,MAX_SAMPLES=250,THR_GOOD=8,MARGIN=2,MAX_POSES=isMobile?1:4;
  let detector,EX=localStorage.getItem('last_ex')||'lunge'; exSel.value=EX; if($('#ex-tag')) $('#ex-tag').textContent=exSel.options[exSel.selectedIndex].text;

  const key=e=>`rehab_${e}_samples_v1`;
  function loadRaw(e){try{const o=JSON.parse(localStorage.getItem(key(e))||'{}');return{good:o.good||[],bad:o.bad||[]}}catch{return{good:[],bad:[]}}}
  const save=(e,o)=>localStorage.setItem(key(e),JSON.stringify(o));
  const addLocal=(e,t,f)=>{const s=loadRaw(e);s[t]=[...s[t],f].slice(-MAX_SAMPLES);save(e,s);updateCounts()}

  // 공유 캐시
  const cloudCache = {};
  async function loadCloudOnce(ex){
    if(cloudCache[ex]) return cloudCache[ex];
    try{
      const data = await fbGet(`/rehab_samples/${ex}`);
      const good=[], bad=[];
      if(data && typeof data==='object'){
        if(data.good && typeof data.good==='object'){
          Object.values(data.good).forEach(v=>{ if(Array.isArray(v)&&v.length===5) good.push(v) });
        }
        if(data.bad && typeof data.bad==='object'){
          Object.values(data.bad).forEach(v=>{ if(Array.isArray(v)&&v.length===5) bad.push(v) });
        }
      }
      cloudCache[ex] = {good,bad};
      updateCounts();
      return cloudCache[ex];
    }catch(e){
      console.warn('클라우드 로드 실패:', e);
      cloudCache[ex] = {good:[],bad:[]};
      updateCounts();
      return cloudCache[ex];
    }
  }
  async function addCloud(ex, type, f){
    try{
      await fbPost(`/rehab_samples/${ex}/${type}`, f);
      if(!cloudCache[ex]) cloudCache[ex]={good:[],bad:[]};
      cloudCache[ex][type].push(f);
      updateCounts();
    }catch(e){
      console.warn('공유 저장 실패:', e);
      showToast('공유 저장 실패(네트워크/규칙/크기 확인)');
    }
  }
  function loadAllMerged(e){
    const base = DEFAULT_SAMPLES[e]||{good:[],bad:[]};
    const loc  = loadRaw(e);
    const cloud= cloudCache[e] || {good:[],bad:[]};
    return { good:[...base.good, ...cloud.good, ...loc.good],
             bad :[...base.bad,  ...cloud.bad,  ...loc.bad ] };
  }
  function updateCounts(){
    const s = loadAllMerged(EX);
    cntG.textContent = s.good.length;
    cntB.textContent = s.bad.length;
    const cloud = cloudCache[EX] || {good:[],bad:[]};
    cntC.textContent = (cloud.good.length + cloud.bad.length);
  }

  /* ===== 각도/기하 ===== */
  const sel=(k,i)=>{const p=k[i],s=p?.score??p?.confidence??0;return s<CONF_THR?null:{x:p.x,y:p.y,score:s}}
  const deg=(a,b,c)=>{if(!a||!b||!c)return null;const v1=[a.x-b.x,a.y-b.y],v2=[c.x-b.x,c.y-b.y],n1=Math.hypot(...v1),n2=Math.hypot(...v2);if(!n1||!n2)return null;let cos=(v1[0]*v2[0]+v1[1]*v2[1])/(n1*n2);cos=Math.max(-1,Math.min(1,cos));return Math.acos(cos)*180/Math.PI}
  const torso=(s,h)=>{if(!s||!h)return null;const vx=h.x-s.x,vy=h.y-s.y,n=Math.hypot(vx,vy);if(!n)return null;let cos=vy/n;cos=Math.max(-1,Math.min(1,cos));return Math.acos(cos)*180/Math.PI}
  const MAE=(a,b)=>a.reduce((s,v,i)=>s+Math.abs(v-b[i]),0)/a.length

  /* ===== 비디오/좌표(거울 모드 포함) ===== */
  let cover = {sx:0,sy:0,sw:1,sh:1,dw:1,dh:1,scale:1};
  function computeCover(dw,dh,vw,vh){
    const s = Math.max(dw/vw, dh/vh);
    const sw = dw/s, sh = dh/s;
    const sx = (vw - sw)/2, sy = (vh - sh)/2;
    cover = {sx,sy,sw,sh,dw,dh,scale:(dw/sw)};
    return cover;
  }
  function drawVideoCover(){
    const {sx,sy,sw,sh,dw,dh} = cover;
    if(MIRROR){
      ctx.save();
      ctx.translate(canvas.width,0);
      ctx.scale(-1,1);
      ctx.drawImage(video, sx,sy,sw,sh, 0,0,dw,dh);
      ctx.restore();
    }else{
      ctx.drawImage(video, sx,sy,sw,sh, 0,0,dw,dh);
    }
  }
  function mapKeypoints(pose){
    const k = pose.keypoints;
    const mapped = k.map(p=>{
      let x = (p.x - cover.sx) * cover.scale;
      const y = (p.y - cover.sy) * cover.scale;
      if(MIRROR) x = canvas.width - x; // 화면 반전과 동일하게 키포인트 좌표도 반전
      return {x,y,score:p.score ?? p.confidence ?? 0};
    });
    return mapped;
  }
  function draw(k){ctx.lineWidth=3;ctx.strokeStyle='#84b6ff';
    const E=[[5,6],[5,7],[7,9],[6,8],[8,10],[5,11],[6,12],[11,12],[11,13],[13,15],[12,14],[14,16]];
    E.forEach(([a,b])=>{const pa=k[a],pb=k[b];if(pa&&pb&&(pa.score??0)>0.2&&(pb.score??0)>0.2){ctx.beginPath();ctx.moveTo(pa.x,pa.y);ctx.lineTo(pb.x,pb.y);ctx.stroke()}});
    k.forEach(p=>{if(p&&(p.score??0)>0.2){ctx.beginPath();ctx.fillStyle='#ffd166';ctx.arc(p.x,p.y,4,0,Math.PI*2);ctx.fill()}});
  }

  /* ===== 리사이즈 ===== */
  function resizeCanvasToVideo(){
    const vw = video.videoWidth || 1280, vh = video.videoHeight || 720;
    const cw = container.clientWidth;
    let ch = Math.round(cw * vh / vw);
    if(isMobile){ const maxH = Math.round(window.innerHeight * 0.7); if(ch > maxH) ch = maxH; }
    canvas.width = cw; canvas.height = ch;
    computeCover(canvas.width, canvas.height, vw, vh);
  }
  window.addEventListener('resize', ()=>{ if(video.srcObject) resizeCanvasToVideo(); });
  window.addEventListener('orientationchange', ()=>{ setTimeout(()=>{ if(video.srcObject) resizeCanvasToVideo(); }, 250); });

  /* ===== 모델/카메라 ===== */
  async function setupCam(facing='user'){
    $('#secureInfo').textContent='HTTPS: '+(window.isSecureContext?'OK':'필요');
    if(!navigator.mediaDevices?.getUserMedia) throw new Error('브라우저가 카메라 API를 지원하지 않음');
    video.setAttribute('playsinline',''); video.setAttribute('webkit-playsinline',''); video.muted=true; video.autoplay=true;
    const constraints={video:{facingMode:facing, width:isMobile?640:1280, height:isMobile?360:720}, audio:false};
    const stream=await navigator.mediaDevices.getUserMedia(constraints); video.srcObject=stream;
    await new Promise((resolve)=>{ let done=false; const ok=()=>{if(done)return; done=true; resolve()};
      setTimeout(ok,5000); video.addEventListener('loadedmetadata',ok,{once:true}); video.addEventListener('canplay',ok,{once:true});
      video.play().then(ok).catch(()=>{video.muted=true; video.play().then(ok).catch(()=>{})}); });
    resizeCanvasToVideo();
  }
  async function initDetector(){ await tf.setBackend('webgl'); await tf.ready();
    const modelType=isMobile?'SinglePose.Lightning':'MultiPose.Lightning';
    detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType});
  }

  /* ===== 특징/판정 ===== */
  function feats(ex,k){
    const LE=sel(k,KP.L_SHO), RE=sel(k,KP.R_SHO),
          LH=sel(k,KP.L_HIP), RH=sel(k,KP.R_HIP),
          LK=sel(k,KP.L_KNEE), RK=sel(k,KP.R_KNEE),
          LA=sel(k,KP.L_ANK),  RA=sel(k,KP.R_ANK);
    const tL=torso(LE,LH), tR=torso(RE,RH), T=(tL!=null&&tR!=null)?(tL+tR)/2:(tL??tR);

    if(ex==='lunge'){
      const f=[deg(LH,LK,LA),deg(RH,RK,RA),deg(LE,LH,LK),deg(RE,RH,RK),T];
      if(f.some(v=>v==null)) return null; return f.map(clamp);
    }
    if(ex==='knee_ext'){
      const Lh=deg(LE,LH,LK), Rh=deg(RE,RH,RK), Hip=(Lh!=null&&Rh!=null)?(Lh+Rh)/2:(Lh??Rh);
      const f=[deg(LH,LK,LA),deg(RH,RK,RA),Hip,T,(Lh??0)];
      if(f.slice(0,4).some(v=>v==null)) return null; return f.map(clamp);
    }
    if(ex==='sit_to_stand'){
      const kneeL = deg(LH,LK,LA), kneeR = deg(RH,RK,RA);
      const hipL  = deg(LE,LH,LK), hipR  = deg(RE,RH,RK);
      if([kneeL,kneeR,hipL,hipR,T].some(v=>v==null)) return null;
      return [clamp(kneeL),clamp(kneeR),clamp(hipL),clamp(hipR),clamp(T)];
    }
    return null;
  }
  function judge(ex,f){
    const s = loadAllMerged(ex);
    const dG=s.good.length?Math.min(...s.good.map(g=>MAE(f,g))):1e9;
    const dB=s.bad.length?Math.min(...s.bad.map(b=>MAE(f,b))):1e9;
    if(!s.good.length&&!s.bad.length) return {t:'샘플을 먼저 저장하세요 (G/B)',tone:'warn',dG,dB};
    if(dG<=THR_GOOD && dG+MARGIN<dB) return {t:'올바른 자세입니다! 계속하세요!',tone:'ok',dG,dB};
    return {t:'틀린 자세입니다. 자세를 바꿔주세요!',tone:'bad',dG,dB};
  }
  let ema=null; const ALPHA=.35;

  async function loop(){
    try{
      drawVideoCover();
      const poses=await detector.estimatePoses(
        video,
        { flipHorizontal: MIRROR, maxPoses: MAX_POSES, scoreThreshold:.25, nmsRadius:20 }
      );
      if(!poses?.length){setStatus('사람을 찾지 못했습니다. 전신이 나오게 서주세요.','warn');debugEl.textContent='';return requestAnimationFrame(loop)}
      if(!isMobile && poses.length!==1){setStatus('사람이 여러명 있습니다. 한 명만 나오게 해주세요.','warn');
        poses.forEach(p=>draw(mapKeypoints(p))); debugEl.textContent=`detect:${poses.length}`; return requestAnimationFrame(loop);}
      const k = mapKeypoints(poses[0]); draw(k);

      const f=feats(EX,k); if(!f){setStatus('관절 신뢰도가 낮습니다. 전신이 보이게 서주세요.','warn');debugEl.textContent='';return requestAnimationFrame(loop)}
      const v=judge(EX,f);
      ema=(ema==null)?(v.tone==='ok'?1:0):(ALPHA*(v.tone==='ok'?1:0)+(1-ALPHA)*ema);
      const tone=ema>0.6?'ok':(ema<0.4?'bad':v.tone);
      setStatus(v.t,tone);
      const base = DEFAULT_SAMPLES[EX]||{good:[],bad:[]};
      const cloud = cloudCache[EX]||{good:[],bad:[]};
      debugEl.textContent=`거울:${MIRROR?'ON':'OFF'} • 운동:${exSel.options[exSel.selectedIndex].text} • dG:${v.dG?.toFixed?.(1)??'-'} • dB:${v.dB?.toFixed?.(1)??'-'} • baseG:${base.good.length} baseB:${base.bad.length} • cloud:${cloud.good.length+cloud.bad.length}`;
    }catch(e){console.error(e);setStatus('추론 오류: '+(e?.message||e),'bad')}
    requestAnimationFrame(loop);
  }

  /* ===== 시작/이벤트 ===== */
  async function start(){
    try{
      setStatus('카메라 연결 중…'); await setupCam();
      setStatus('모델 로딩 중…');  await initDetector();
      await loadCloudOnce(EX);
      updateCounts();
      setStatus('카메라 준비 완료 – 바로 시연 가능'); loop();
    }catch(e){
      console.error(e); setStatus('초기화 실패: '+(e?.message||e),'bad');
      $('#starter').style.display='flex'; showToast('초기화 실패. 권한/HTTPS/보안 앱 확인');
    }
  }
  $('#btnStart').onclick=()=>{ $('#starter').style.display='none'; start(); };
  if(!isMobile) start();

  let facing='user';
  $('#flipCam').onclick=async()=>{ video.srcObject?.getTracks()?.forEach(t=>t.stop()); facing=(facing==='user')?'environment':'user'; await setupCam(facing); };

  async function snap(type){
    if(!(await ensureAuth('샘플 저장(학습)'))) return;
    const poses=await detector.estimatePoses(video,{flipHorizontal:MIRROR,maxPoses:MAX_POSES});
    if(!poses?.length){showToast('사람이 인식되지 않습니다');return;}
    const k = mapKeypoints(poses[0]);
    const f=feats(EX, k); if(!f){showToast('관절 신뢰도 낮음');return;}
    addLocal(EX,type,f);
    await addCloud(EX,type,f);
    showToast(type==='good'?'좋은 샘플 저장(로컬+공유) 완료':'나쁜 샘플 저장(로컬+공유) 완료');
  }
  $('#btn-good').onclick=()=>snap('good');
  $('#btn-bad').onclick =()=>snap('bad');

  // 단축키: G/B
  window.addEventListener('keydown',e=>{
    if(e.key==='g'||e.key==='G') $('#btn-good').click();
    if(e.key==='b'||e.key==='B') $('#btn-bad').click();
  });

  // 공유 데이터 전체 초기화: 3단 경고 + 비밀번호
  async function tripleDangerReset(){
    if(!(await ensureAuth('공유 데이터 전체 초기화'))) return;

    if(!confirm('⚠️ [1/3] 공유 데이터(모든 운동의 클라우드 샘플)를 전부 삭제합니다. 계속합니까?')) return;
    const word = prompt('⚠️ [2/3] 되돌릴 수 없습니다. 계속하려면 대문자로 DELETE 를 입력하세요.');
    if(word !== 'DELETE'){ showToast('취소됨'); return; }
    if(!confirm('⚠️ [3/3] 정말 진행할까요? 이 작업은 영구적으로 삭제합니다.')) return;

    try{
      await fbDelete(`/rehab_samples`);
      Object.keys(cloudCache).forEach(k=>{ cloudCache[k]={good:[],bad:[]} });
      updateCounts();
      showToast('공유 데이터 전체 초기화 완료');
    }catch(e){
      console.error(e); showToast('공유 초기화 실패(권한/규칙 확인)');
    }
  }
  $('#btn-reset-cloud').onclick = tripleDangerReset;

  exSel.addEventListener('change', async ()=>{
    EX=exSel.value; localStorage.setItem('last_ex',EX);
    const tagEl = $('#ex-tag'); if(tagEl) tagEl.textContent=exSel.options[exSel.selectedIndex].text;
    await loadCloudOnce(EX);
    updateCounts(); ema=null; showToast('운동 변경');
  });
  </script>
</body>
</html>
